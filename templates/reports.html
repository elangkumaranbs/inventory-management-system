{% extends "base.html" %}

{% block title %}Reports - Inventory Management System{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <h1 class="page-title">
        <i class="bi bi-graph-up"></i>
        Inventory Reports
    </h1>
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-primary" onclick="printReport()">
            <i class="bi bi-printer me-2"></i>Print
        </button>
        <button type="button" class="btn btn-outline-success" onclick="exportReport()">
            <i class="bi bi-download me-2"></i>Export CSV
        </button>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-0 bg-primary text-white">
            <div class="card-body text-center">
                <div class="display-6 mb-2">
                    <i class="bi bi-box"></i>
                </div>
                <h5>{{ grid_data|length }}</h5>
                <p class="mb-0">Total Entries</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-0 bg-success text-white">
            <div class="card-body text-center">
                <div class="display-6 mb-2">
                    <i class="bi bi-arrow-up"></i>
                </div>
                <h5>{{ positive_items }}</h5>
                <p class="mb-0">Positive Stock</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-0 bg-warning text-white">
            <div class="card-body text-center">
                <div class="display-6 mb-2">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <h5>{{ low_stock_items }}</h5>
                <p class="mb-0">Low Stock Items</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-0 bg-info text-white">
            <div class="card-body text-center">
                <div class="display-6 mb-2">
                    <i class="bi bi-calculator"></i>
                </div>
                <h5>{{ total_quantity }}</h5>
                <p class="mb-0">Total Quantity</p>
            </div>
        </div>
    </div>
</div>

<!-- Balance Grid -->
{% if grid_data %}
<div class="card border-0 shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Product Balance Grid</h5>
        <div class="input-group" style="width: 300px;">
            <input type="text" class="form-control" id="searchFilter" placeholder="Search products or warehouses...">
            <span class="input-group-text">
                <i class="bi bi-search"></i>
            </span>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="balanceGrid">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Warehouse</th>
                        <th class="text-end">Qty</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in grid_data %}
                    <tr>
                        <td>{{ item.Product }}</td>
                        <td>{{ item.Warehouse }}</td>
                        <td class="text-end">
                            <span class="fs-5 {% if item.Qty > 0 %}quantity-positive{% elif item.Qty < 0 %}quantity-negative{% else %}quantity-zero{% endif %}">
                                {{ item.Qty }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer text-muted">
        <div class="row">
            <div class="col-md-6">
                <small><i class="bi bi-info-circle"></i> Showing {{ inventory_data|length }} inventory items with stock</small>
            </div>
            <div class="col-md-6 text-end">
                <small>Last updated: {{ moment().format('MMMM Do YYYY, h:mm:ss a') if moment is defined else 'Now' }}</small>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="text-center py-5">
    <div class="display-1 text-muted mb-3">
        <i class="bi bi-graph-up"></i>
    </div>
    <h4>No Inventory Data</h4>
    <p class="text-muted">
        No products with stock found. Start by adding products and recording some movements.
    </p>
    <div class="mt-3">
        <a href="{{ url_for('main.add_product') }}" class="btn btn-primary me-2">
            <i class="bi bi-plus"></i> Add Product
        </a>
        <a href="{{ url_for('main.add_movement') }}" class="btn btn-warning">
            <i class="bi bi-arrow-left-right"></i> Add Movement
        </a>
    </div>
</div>
{% endif %}

<!-- Charts Section -->
{% if inventory_data %}
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Stock by Location</h5>
            </div>
            <div class="card-body">
                <canvas id="locationChart" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Stock by Product</h5>
            </div>
            <div class="card-body">
                <canvas id="productChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if inventory_data %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Search functionality
document.getElementById('searchFilter').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const table = document.getElementById('balanceGrid');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const text = row.textContent.toLowerCase();
        
        if (text.indexOf(searchTerm) > -1) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
});

// Prepare data for charts
const inventoryData = [
    {% for item in grid_data %}
    {
        product_name: "{{ item.Product }}",
        location_name: "{{ item.Warehouse }}",
        balance: {{ item.Qty }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

// Location Chart
const locationData = {};
inventoryData.forEach(item => {
    const locationName = item.location_name;
    if (locationData[locationName]) {
        locationData[locationName] += item.balance;
    } else {
        locationData[locationName] = item.balance;
    }
});

const locationChart = new Chart(document.getElementById('locationChart'), {
    type: 'doughnut',
    data: {
        labels: Object.keys(locationData),
        datasets: [{
            data: Object.values(locationData),
            backgroundColor: [
                '#FF6384',
                '#36A2EB',
                '#FFCE56',
                '#4BC0C0',
                '#9966FF',
                '#FF9F40'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Product Chart
const productData = {};
inventoryData.forEach(item => {
    const productName = item.product_name;
    if (productData[productName]) {
        productData[productName] += item.balance;
    } else {
        productData[productName] = item.balance;
    }
});

const productChart = new Chart(document.getElementById('productChart'), {
    type: 'bar',
    data: {
        labels: Object.keys(productData),
        datasets: [{
            label: 'Total Quantity',
            data: Object.values(productData),
            backgroundColor: '#36A2EB',
            borderColor: '#2196F3',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});
</script>
{% endif %}

<script>
function printReport() {
    window.print();
}

function exportReport() {
    // Simple CSV export functionality
    const table = document.getElementById('balanceGrid');
    let csv = 'Product,Warehouse,Qty\n';
    
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName('td');
        const rowData = [];
        
        // Extract text content from cells (3 columns: Product, Warehouse, Qty)
        rowData.push('"' + cells[0].textContent.trim() + '"');
        rowData.push('"' + cells[1].textContent.trim() + '"');
        rowData.push(cells[2].textContent.trim());
        
        csv += rowData.join(',') + '\n';
    }
    
    // Create download link
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', 'balance-grid-' + new Date().toISOString().slice(0, 10) + '.csv');
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}
</script>
{% endblock %}
